<!DOCTYPE html>
<html>
<head>
    <title>VoiceBot AI Installer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <HTA:APPLICATION
        ID="VoiceBotInstaller"
        APPLICATIONNAME="VoiceBot Installer"
        BORDER="thin"
        BORDERSTYLE="normal"
        CAPTION="yes"
        CONTEXTMENU="no"
        INNERBORDER="no"
        MAXIMIZEBUTTON="no"
        MINIMIZEBUTTON="yes"
        NAVIGABLE="no"
        SCROLL="auto"
        SCROLLFLAT="yes"
        SELECTION="no"
        SHOWINTASKBAR="yes"
        SINGLEINSTANCE="yes"
        SYSMENU="yes"
        VERSION="1.0"
        WINDOWSTATE="normal"
    />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100%;
            padding: 15px;
        }
        .container { max-width: 780px; margin: 0 auto; }
        h1 { text-align: center; color: #89b4fa; margin-bottom: 8px; font-size: 28px; }
        .subtitle { text-align: center; color: #a6adc8; margin-bottom: 20px; font-size: 15px; }
        
        /* Mode Selection */
        .mode-selection {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .mode-btn {
            flex: 1;
            padding: 25px 20px;
            border: 2px solid #45475a;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .mode-btn:hover {
            border-color: #89b4fa;
            background: rgba(137, 180, 250, 0.1);
        }
        .mode-btn.selected {
            border-color: #a6e3a1;
            background: rgba(166, 227, 161, 0.15);
        }
        .mode-btn h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #cdd6f4;
        }
        .mode-btn.selected h3 {
            color: #a6e3a1;
        }
        .mode-btn p {
            font-size: 13px;
            color: #6c7086;
        }
        .mode-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }
        
        .warning-box {
            background: rgba(243, 139, 168, 0.15);
            border: 1px solid #f38ba8;
            border-radius: 10px;
            padding: 14px 20px;
            margin-bottom: 18px;
            font-size: 14px;
            color: #f38ba8;
            text-align: center;
        }
        .instructions {
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            display: none;
        }
        .instructions.show { display: block; }
        .instructions h3 { color: #f9e2af; margin-bottom: 10px; font-size: 15px; }
        .instructions ol { margin-left: 25px; color: #cdd6f4; font-size: 14px; line-height: 2; }
        .input-group { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; display: none; }
        .input-group.show { display: flex; }
        .input-group label { width: 110px; font-size: 15px; }
        .input-group input {
            flex: 1; padding: 12px 15px; border: 1px solid #45475a; border-radius: 6px;
            background: #313244; color: #fff; font-size: 15px; font-family: Consolas, monospace;
        }
        .btn {
            padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 15px; font-weight: bold;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary {
            background: #a6e3a1; color: #1e1e2e; width: 100%;
            padding: 16px; font-size: 18px; margin-bottom: 18px; display: none;
        }
        .btn-primary.show { display: block; }
        .btn-secondary { background: #45475a; color: #fff; }
        .progress-section { margin-bottom: 12px; display: none; }
        .progress-section.show { display: block; }
        .progress-section h3 { font-size: 15px; margin-bottom: 8px; color: #cdd6f4; }
        .progress-bar {
            height: 28px; background: #313244; border-radius: 6px;
            overflow: hidden; position: relative;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #89b4fa, #a6e3a1);
            width: 0%; border-radius: 5px;
        }
        .progress-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 13px; font-weight: bold; color: #fff; text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }
        .log-box {
            background: #11111b; border: 1px solid #313244; border-radius: 6px;
            padding: 12px; height: 180px; overflow-y: auto;
            font-family: Consolas, monospace; font-size: 13px; line-height: 1.6;
            display: none;
        }
        .log-box.show { display: block; }
        .log-box .success { color: #a6e3a1; }
        .log-box .error { color: #f38ba8; }
        .log-box .info { color: #89b4fa; }
        .log-box .warn { color: #f9e2af; }
        .status-bar {
            margin-top: 10px; padding: 10px 15px; background: rgba(255,255,255,0.05);
            border-radius: 6px; font-size: 14px; color: #a6adc8; display: none;
        }
        .status-bar.show { display: block; }
        .step-indicator { display: none; justify-content: space-between; margin-bottom: 12px; }
        .step-indicator.show { display: flex; }
        .step {
            flex: 1; text-align: center; padding: 10px 6px; background: #313244;
            margin: 0 3px; border-radius: 6px; font-size: 12px; color: #6c7086;
        }
        .step.active { background: #89b4fa; color: #1e1e2e; }
        .step.done { background: #a6e3a1; color: #1e1e2e; }
        .step.error { background: #f38ba8; color: #1e1e2e; }
        
        .update-notification {
            background: linear-gradient(135deg, rgba(166, 227, 161, 0.2), rgba(137, 180, 250, 0.2));
            border: 2px solid #a6e3a1;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 18px;
            display: none;
        }
        .update-notification.show { display: block; }
        .update-notification h3 {
            color: #a6e3a1;
            font-size: 16px;
            margin-bottom: 12px;
        }
        .update-notification .changelog {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 13px;
            color: #cdd6f4;
            max-height: 120px;
            overflow-y: auto;
        }
        .update-notification .btn-update {
            background: #a6e3a1;
            color: #1e1e2e;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
        }
        .update-notification .btn-skip {
            background: #45475a;
            color: #fff;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>C&#224;i &#272;&#7863;t AI cho loa Phicomm R1</h1>
        <p class="subtitle" style="display:block; margin-bottom:15px; font-size:14px;">By V&#7885;c S&#297;</p>

        <div class="warning-box">
            ‚ö† KH√îNG ƒê∆Ø·ª¢C R√öT ƒêI·ªÜN C·ª¶A LOA KHI ƒêANG C√ÄI ƒê·∫∂T!
        </div>

        <!-- Button ki·ªÉm tra v√† t·∫£i APK -->
        <button id="downloadBtn" class="btn btn-primary show" onclick="checkAndDownloadAPK()" style="margin-bottom: 20px;">
            üì• KI·ªÇM TRA V√Ä T·∫¢I APK M·ªöI NH·∫§T
        </button>

        <!-- Mode Selection -->
        <div class="mode-selection">
            <div class="mode-btn" id="modeNew" onclick="selectMode('new')">
                <div class="mode-icon">üÜï</div>
                <h3>C√ÄI ƒê·∫∂T M·ªöI</h3>
                <p>Loa ch∆∞a c√≥ AI, c√†i l·∫ßn ƒë·∫ßu</p>
            </div>
            <div class="mode-btn" id="modeUpdate" onclick="selectMode('update')">
                <div class="mode-icon">üîÑ</div>
                <h3>C·∫¨P NH·∫¨T</h3>
                <p>Loa ƒë√£ c√≥ AI, n√¢ng c·∫•p phi√™n b·∫£n</p>
            </div>
        </div>

        <!-- Instructions for New Install -->
        <div class="instructions" id="instructNew">
            <h3>H∆∞·ªõng d·∫´n c√†i m·ªõi:</h3>
            <ol>
                <li><strong>GI·ªÆ N√öT</strong> loa ƒë·∫øn khi nghe "V√†o ch·∫ø ƒë·ªô c√†i ƒë·∫∑t WiFi"</li>
                <li>K·∫øt n·ªëi m√°y t√≠nh v√†o WiFi: <strong>Phicomm_R1_xxx</strong></li>
                <li>IP m·∫∑c ƒë·ªãnh: <strong>192.168.43.1</strong> (ƒë√£ ƒëi·ªÅn s·∫µn)</li>
                <li>Nh·∫•n <strong>"B·∫ÆT ƒê·∫¶U C√ÄI ƒê·∫∂T"</strong> <em style="color:#f9e2af;">(n·∫øu th·∫•t b·∫°i, b·∫•m l·∫°i v√†i l·∫ßn)</em></li>
            </ol>
        </div>

        <!-- Instructions for Update -->
        <div class="instructions" id="instructUpdate">
            <h3>H∆∞·ªõng d·∫´n c·∫≠p nh·∫≠t:</h3>
            <ol>
                <li>K·∫øt n·ªëi loa v√†o WiFi nh√†</li>
                <li>H·ªèi loa <strong>"<em>ƒê·ªãa ch·ªâ IP c·ªßa b·∫°n l√† g√¨?</em>"</strong></li>
                <li>Nh·∫≠p IP v√†o √¥ b√™n d∆∞·ªõi</li>
                <li>Nh·∫•n <strong>"B·∫ÆT ƒê·∫¶U C·∫¨P NH·∫¨T"</strong> <em style="color:#f9e2af;">(n·∫øu th·∫•t b·∫°i, b·∫•m l·∫°i v√†i l·∫ßn)</em></li>
            </ol>
        </div>

        <div class="input-group" id="ipGroup">
            <label>ƒê·ªãa ch·ªâ IP:</label>
            <input type="text" id="ipAddress" value="" placeholder="V√≠ d·ª•: 192.168.1.100">
        </div>

        <button class="btn btn-primary" id="installBtn" onclick="startInstall()">
            B·∫ÆT ƒê·∫¶U C√ÄI ƒê·∫∂T
        </button>

        <!-- Steps for New Install (6 steps) -->
        <div class="step-indicator" id="stepsNew">
            <div class="step" id="stepN1">1. K·∫øt n·ªëi</div>
            <div class="step" id="stepN2">2. T·∫Øt app c≈©</div>
            <div class="step" id="stepN3">3. Copy APK</div>
            <div class="step" id="stepN4">4. C√†i ƒë·∫∑t</div>
            <div class="step" id="stepN5">5. Quy·ªÅn</div>
            <div class="step" id="stepN6">6. Xong</div>
        </div>

        <!-- Steps for Update (5 steps) -->
        <div class="step-indicator" id="stepsUpdate">
            <div class="step" id="stepU1">1. K&#7871;t n&#7889;i</div>
            <div class="step" id="stepU2">2. Copy APK</div>
            <div class="step" id="stepU3">3. C&#224;i &#273;&#7863;t</div>
            <div class="step" id="stepU4">4. Quy&#7873;n</div>
            <div class="step" id="stepU5">5. Xong</div>
        </div>

        <div class="progress-section" id="progressSection">
            <h3>Ti&#7871;n tr&#236;nh:</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <span class="progress-text" id="progressText">0%</span>
            </div>
        </div>

        <div class="log-box" id="logBox"></div>

        <div class="status-bar" id="statusBar">
            Vui l&#242;ng ch&#7885;n ch&#7871; &#273;&#7897; c&#224;i &#273;&#7863;t.
        </div>
    </div>

    <script type="text/javascript">
        var shell = new ActiveXObject("WScript.Shell");
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var scriptDir = "";
        var adbPath = "";
        var apkPath = "";
        var versionJsonPath = "";
        var isInstalling = false;
        var installMode = "";
        var deviceIP = "";
        var localVersion = "";
        var serverVersion = "";
        var isDownloading = false;

        function init() {
            try {
                var fullPath = document.location.href;
                fullPath = fullPath.replace("file:///", "").replace(/\//g, "\\");
                fullPath = unescape(fullPath);
                scriptDir = fullPath.substring(0, fullPath.lastIndexOf("\\"));
                adbPath = scriptDir + "\\adb.exe";
                apkPath = scriptDir + "\\app-voicebot.apk";
                versionJsonPath = scriptDir + "\\version.json";
                
                if (!fso.FileExists(adbPath)) {
                    alert("Kh√¥ng t√¨m th·∫•y adb.exe!");
                }
                
                // ƒê·ªçc version local
                readLocalVersion();
                
                // Hi·ªÉn th·ªã c√°c ph·∫ßn UI c·∫ßn thi·∫øt
                document.getElementById("progressSection").className = "progress-section show";
                document.getElementById("logBox").className = "log-box show";
                document.getElementById("statusBar").className = "status-bar show";
                document.getElementById("statusBar").innerHTML = "S·∫µn s√†ng ki·ªÉm tra c·∫≠p nh·∫≠t.";
                
                // ·∫®n t·∫•t c·∫£ UI ban ƒë·∫ßu, ch·ªâ hi·ªán n√∫t ki·ªÉm tra
                hideAllUI();
                
            } catch(e) {
                alert("L·ªói kh·ªüi t·∫°o: " + e.message);
            }
        }

        function readLocalVersion() {
            try {
                if (fso.FileExists(versionJsonPath)) {
                    try {
                        // Delete and recreate if corrupted
                        var file = fso.OpenTextFile(versionJsonPath, 1);
                        var content = file.ReadAll();
                        file.Close();
                        
                        // Remove all non-printable characters
                        var cleanContent = "";
                        for (var i = 0; i < content.length; i++) {
                            var code = content.charCodeAt(i);
                            // Keep only printable ASCII + newlines/tabs
                            if ((code >= 32 && code <= 126) || code === 10 || code === 13 || code === 9) {
                                cleanContent += content.charAt(i);
                            }
                        }
                        
                        var versionData = JSON.parse(cleanContent);
                        localVersion = versionData.latest_version || "0.0.0";
                        logMessage("[INFO] Phien ban APK hien tai: " + localVersion, "info");
                    } catch(parseError) {
                        logMessage("[CANH BAO] Loi doc version.json: " + parseError.message, "warn");
                        // Delete corrupted file and start fresh
                        try { fso.DeleteFile(versionJsonPath); } catch(e) {}
                        localVersion = "0.0.0";
                    }
                } else {
                    localVersion = "0.0.0";
                    logMessage("[C·∫¢NH B√ÅO] Ch∆∞a c√≥ file version.json, s·∫Ω t·∫£i m·ªõi", "warn");
                    // T·∫°o file version.json r·ªóng
                    var defaultJson = '{"latest_version":"0.0.0","release_date":"","apk_url":"","changelog":[]}';
                    var f = fso.CreateTextFile(versionJsonPath, true);
                    f.Write(defaultJson);
                    f.Close();
                }
            } catch(e) {
                localVersion = "0.0.0";
                logMessage("[L·ªñI] Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c version local: " + e.message, "error");
            }
        }

        function readGitHubFile(filePath) {
            try {
                var http = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
                var url = "https://raw.githubusercontent.com/bangdc90/cai_dat_ai/main/" + filePath;
                
                http.Open("GET", url, false);
                http.SetTimeouts(10000, 10000, 10000, 10000);
                http.Send();
                
                if (http.Status === 200) {
                    var responseText = http.ResponseText;
                    // Remove UTF-8 BOM if present (0xEF 0xBB 0xBF)
                    if (responseText.charCodeAt(0) === 0xFEFF) {
                        responseText = responseText.substring(1);
                    }
                    return responseText;
                }
                logMessage("[L·ªñI] HTTP Status: " + http.Status, "error");
                return null;
            } catch(e) {
                logMessage("[L·ªñI] Fetch: " + e.message, "error");
                return null;
            }
        }

        function compareVersions(v1, v2) {
            var parts1 = v1.split('.');
            var parts2 = v2.split('.');
            
            for (var i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                var p1 = parseInt(parts1[i] || 0);
                var p2 = parseInt(parts2[i] || 0);
                if (p1 > p2) return 1;
                if (p1 < p2) return -1;
            }
            return 0;
        }

        function checkAndDownloadAPK() {
            if (isDownloading) return;
            
            isDownloading = true;
            dimOtherUI();
            
            logMessage("", "info");
            logMessage("=========================================", "info");
            logMessage("KI·ªÇM TRA C·∫¨P NH·∫¨T", "info");
            logMessage("=========================================", "info");
            
            try {
                // Fetch version t·ª´ server
                logMessage("[INFO] ƒêang ki·ªÉm tra phi√™n b·∫£n m·ªõi...", "info");
                setStatus("ƒêang ki·ªÉm tra c·∫≠p nh·∫≠t...");
                setProgress(10);
                
                var versionJson = readGitHubFile("version.json");
                if (!versionJson) {
                    throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra Internet.");
                }
                
                var serverInfo = JSON.parse(versionJson);
                serverVersion = serverInfo.latest_version;
                
                setProgress(20);
                logMessage("[INFO] Phi√™n b·∫£n local: " + localVersion, "info");
                logMessage("[INFO] Phi√™n b·∫£n server: " + serverVersion, "info");
                
                // So s√°nh version
                if (compareVersions(serverVersion, localVersion) <= 0) {
                    setProgress(100);
                    logMessage("[OK] File APK hi·ªán t·∫°i ƒë√£ l√† phi√™n b·∫£n m·ªõi nh·∫•t: " + localVersion, "success");
                    logMessage("=========================================", "success");
                    logMessage("[OK] S·∫¥N S√ÄNG C√ÄI ƒê·∫∂T!", "success");
                    logMessage("=========================================", "success");
                    setStatus("[OK] APK ƒë√£ s·∫µn s√†ng: v" + localVersion);
                    
                    // Show changelog popup
                    var changelogText = "";
                    if (serverInfo.changelog && serverInfo.changelog.length > 0) {
                        for (var i = 0; i < serverInfo.changelog.length; i++) {
                            changelogText += "  " + serverInfo.changelog[i] + "\n";
                        }
                    }
                    
                    var popupMsg = "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" +
                                  "  PHI√äN B·∫¢N: " + localVersion + "\n" +
                                  "  Ng√†y ph√°t h√†nh: " + serverInfo.release_date + "\n" +
                                  "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n" +
                                  "T√çNH NƒÇNG:\n\n" +
                                  changelogText +
                                  "\nAPK ƒë√£ s·∫µn s√†ng ƒë·ªÉ c√†i ƒë·∫∑t!";
                    alert(popupMsg);
                    
                    showModeSelection();
                    isDownloading = false;
                    return;
                    // ƒê√£ l√† m·ªõi nh·∫•t
                    setProgress(100);
                    logMessage("[OK] APK ƒë√£ l√† phi√™n b·∫£n m·ªõi nh·∫•t!", "success");
                    setStatus("[OK] APK ƒë√£ s·∫µn s√†ng: v" + localVersion);
                    showInstallUI();
                    return;
                }
                
                // C·∫ßn t·∫£i APK m·ªõi
                logMessage("[INFO] Ph√°t hi·ªán phi√™n b·∫£n m·ªõi: " + serverVersion, "info");
                logMessage("[INFO] ƒêang t·∫£i APK m·ªõi...", "warn");
                setStatus("ƒêang t·∫£i APK phi√™n b·∫£n " + serverVersion + "...");
                setProgress(30);
                
                var apkUrl = serverInfo.apk_url || "https://raw.githubusercontent.com/bangdc90/cai_dat_ai/main/app-voicebot.apk";
                var http = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
                
                http.Open("GET", apkUrl, false);
                http.SetTimeouts(120000, 120000, 120000, 120000);
                
                logMessage("[CH·ªú] ƒêang t·∫£i file (~17MB), vui l√≤ng ch·ªù...", "warn");
                http.Send();
                
                if (http.Status !== 200) {
                    throw new Error("L·ªói t·∫£i APK: HTTP " + http.Status);
                }
                
                setProgress(70);
                logMessage("[OK] T·∫£i th√†nh c√¥ng! Dung l∆∞·ª£ng: " + Math.round(http.ResponseBody.length / 1024 / 1024 * 10) / 10 + " MB", "success");
                
                // L∆∞u APK
                logMessage("[INFO] ƒêang l∆∞u file...", "info");
                var stream = new ActiveXObject("ADODB.Stream");
                stream.Type = 1;
                stream.Open();
                stream.Write(http.ResponseBody);
                
                if (fso.FileExists(apkPath)) {
                    fso.DeleteFile(apkPath);
                }
                
                stream.SaveToFile(apkPath, 2);
                stream.Close();
                
                setProgress(90);
                
                // T·∫£i file version.json tr·ª±c ti·∫øp t·ª´ GitHub
                logMessage("[INFO] ƒêang t·∫£i version.json...", "info");
                try {
                    var httpVer = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
                    httpVer.Open("GET", "https://raw.githubusercontent.com/bangdc90/cai_dat_ai/main/version.json", false);
                    httpVer.SetTimeouts(10000, 10000, 10000, 10000);
                    httpVer.Send();
                    
                    if (httpVer.Status === 200) {
                        var streamVer = new ActiveXObject("ADODB.Stream");
                        streamVer.Type = 2; // Text
                        streamVer.Charset = "utf-8";
                        streamVer.Open();
                        streamVer.WriteText(httpVer.ResponseText);
                        
                        if (fso.FileExists(versionJsonPath)) {
                            fso.DeleteFile(versionJsonPath);
                        }
                        
                        streamVer.SaveToFile(versionJsonPath, 2);
                        streamVer.Close();
                        logMessage("[OK] ƒê√£ c·∫≠p nh·∫≠t version.json", "success");
                    }
                } catch(e) {
                    logMessage("[C·∫¢NH B√ÅO] Kh√¥ng t·∫£i ƒë∆∞·ª£c version.json: " + e.message, "warn");
                }
                
                localVersion = serverVersion;
                
                setProgress(100);
                logMessage("[OK] ƒê√£ l∆∞u APK phi√™n b·∫£n " + serverVersion, "success");
                logMessage("=========================================", "success");
                logMessage("[OK] S·∫¥N S√ÄNG C√ÄI ƒê·∫∂T!", "success");
                logMessage("=========================================", "success");
                
                setStatus("[OK] APK ƒë√£ s·∫µn s√†ng: v" + serverVersion);
                
                // Show changelog popup
                var changelogText = "";
                if (serverInfo.changelog && serverInfo.changelog.length > 0) {
                    for (var i = 0; i < serverInfo.changelog.length; i++) {
                        changelogText += "  " + serverInfo.changelog[i] + "\n";
                    }
                }
                
                var popupMsg = "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" +
                              "  ƒê√É T·∫¢I PHI√äN B·∫¢N: " + serverVersion + "\n" +
                              "  Ng√†y ph√°t h√†nh: " + serverInfo.release_date + "\n" +
                              "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n" +
                              "T√çNH NƒÇNG M·ªöI:\n\n" +
                              changelogText +
                              "\nAPK ƒë√£ s·∫µn s√†ng ƒë·ªÉ c√†i ƒë·∫∑t!";
                alert(popupMsg);
                
                showModeSelection();
                
            } catch(e) {
                setProgress(0);
                logMessage("[L·ªñI] " + e.message, "error");
                setStatus("[L·ªñI] " + e.message);
                
                var fallbackMsg = "L·ªói t·∫£i c·∫≠p nh·∫≠t!\n\n" + 
                                  e.message + "\n\n" +
                                  "B·∫°n c√≥ th·ªÉ t·∫£i th·ªß c√¥ng t·∫°i:\n" +
                                  "pikapet.net/loa-ai\n\n" +
                                  "Sau ƒë√≥ ghi ƒë√® file app-voicebot.apk";
                alert(fallbackMsg);
                undimOtherUI();
            } finally {
                isDownloading = false;
            }
        }

        function hideInstallUI() {
            document.getElementById("instructNew").style.display = "none";
            document.getElementById("instructUpdate").style.display = "none";
            document.getElementById("ipGroup").style.display = "none";
            document.getElementById("installBtn").style.display = "none";
            document.getElementById("stepsNew").style.display = "none";
            document.getElementById("stepsUpdate").style.display = "none";
        }
        
        function hideAllUI() {
            document.querySelector(".mode-selection").style.display = "none";
            hideInstallUI();
        }
        
        function showModeSelection() {
            undimOtherUI();
            document.querySelector(".mode-selection").style.display = "flex";
        }

        function showInstallUI() {
            // Don't call undimOtherUI here, it will be called from selectMode
            document.getElementById("ipGroup").style.display = "flex";
            document.getElementById("installBtn").style.display = "block";
        }

        function dimOtherUI() {
            var container = document.querySelector(".container");
            container.style.opacity = "0.5";
            container.style.pointerEvents = "none";
            document.getElementById("progressSection").style.opacity = "1";
            document.getElementById("progressSection").style.pointerEvents = "auto";
            document.getElementById("logBox").style.opacity = "1";
            document.getElementById("statusBar").style.opacity = "1";
        }

        function undimOtherUI() {
            var container = document.querySelector(".container");
            container.style.opacity = "1";
            container.style.pointerEvents = "auto";
        }

        function logMessage(msg, type) {
            var logBox = document.getElementById("logBox");
            var time = new Date();
            var timestamp = ("0" + time.getHours()).slice(-2) + ":" + 
                           ("0" + time.getMinutes()).slice(-2) + ":" + 
                           ("0" + time.getSeconds()).slice(-2);
            logBox.innerHTML += '<div class="' + (type || "info") + '">[' + timestamp + '] ' + msg + '</div>';
            logBox.scrollTop = logBox.scrollHeight;
        }

        function setStatus(msg) { document.getElementById("statusBar").innerHTML = msg; }
        function setProgress(percent) {
            document.getElementById("progressFill").style.width = percent + "%";
            document.getElementById("progressText").innerHTML = percent + "%";
        }
        
        function setStep(stepNum, status) {
            var prefix = installMode === "new" ? "stepN" : "stepU";
            var el = document.getElementById(prefix + stepNum);
            if (el) el.className = "step " + status;
        }

        function runAdbCommand(args) {
            try {
                var tempFile = scriptDir + "\\adb_output.tmp";
                var fullCmd = 'cmd /c ""' + adbPath + '" ' + args + ' > "' + tempFile + '" 2>&1"';
                shell.Run(fullCmd, 0, true);
                
                var output = "";
                if (fso.FileExists(tempFile)) {
                    var file = fso.OpenTextFile(tempFile, 1);
                    if (!file.AtEndOfStream) {
                        output = file.ReadAll();
                    }
                    file.Close();
                    try { fso.DeleteFile(tempFile); } catch(e) {}
                }
                return output.trim();
            } catch(e) {
                return "ERROR: " + e.message;
            }
        }

        function sleep(ms) {
            var start = new Date().getTime();
            while (new Date().getTime() < start + ms);
        }

        function reconnectAdb() {
            logMessage("[C·∫¢NH B√ÅO] M·∫•t k·∫øt n·ªëi ADB, ƒëang k·∫øt n·ªëi l·∫°i...", "warn");
            runAdbCommand("connect " + deviceIP + ":5555");
            sleep(2000);
        }

        function checkConnection(output) {
            return output.indexOf("no devices") < 0 && output.indexOf("error") < 0;
        }

        function selectMode(mode) {
            installMode = mode;
            
            // Hide download button
            document.getElementById("downloadBtn").style.display = "none";
            
            document.getElementById("modeNew").className = "mode-btn" + (mode === "new" ? " selected" : "");
            document.getElementById("modeUpdate").className = "mode-btn" + (mode === "update" ? " selected" : "");
            
            // Show/hide instructions based on mode
            if (mode === "new") {
                document.getElementById("instructNew").style.display = "block";
                document.getElementById("instructUpdate").style.display = "none";
                document.getElementById("stepsNew").style.display = "flex";
                document.getElementById("stepsUpdate").style.display = "none";
                document.getElementById("ipAddress").value = "192.168.43.1";
                document.getElementById("installBtn").innerHTML = "B·∫ÆT ƒê·∫¶U C√ÄI ƒê·∫∂T M·ªöI";
            } else {
                document.getElementById("instructNew").style.display = "none";
                document.getElementById("instructUpdate").style.display = "block";
                document.getElementById("stepsNew").style.display = "none";
                document.getElementById("stepsUpdate").style.display = "flex";
                document.getElementById("ipAddress").value = "";
                document.getElementById("installBtn").innerHTML = "B·∫ÆT ƒê·∫¶U C·∫¨P NH·∫¨T";
            }
            
            // Show IP input and install button
            document.getElementById("ipGroup").style.display = "flex";
            document.getElementById("installBtn").style.display = "block";
            
            // Scroll to instructions
            setTimeout(function() {
                var instruction = mode === "new" ? document.getElementById("instructNew") : document.getElementById("instructUpdate");
                instruction.scrollIntoView({ behavior: "smooth", block: "start" });
            }, 100);
        }

        function testConnection() {
            var ip = document.getElementById("ipAddress").value;
            if (!ip) {
                alert("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ IP!");
                return;
            }
            deviceIP = ip;
            logMessage("ƒêang ki·ªÉm tra k·∫øt n·ªëi ƒë·∫øn " + ip + "...", "info");
            setStatus("ƒêang ki·ªÉm tra k·∫øt n·ªëi...");
            
            runAdbCommand("disconnect");
            sleep(500);
            
            shell.Run('cmd /c taskkill /f /t /im adb.exe', 0, true);
            sleep(500);
            runAdbCommand("devices");
            sleep(500);
            
            var result = runAdbCommand("connect " + ip + ":5555");
            logMessage(result, result.indexOf("connected") >= 0 ? "success" : "error");
            
            var devices = runAdbCommand("devices");
            if (devices.indexOf(ip) >= 0 && devices.indexOf("device") >= 0) {
                setStatus("[OK] K·∫øt n·ªëi th√†nh c√¥ng! S·∫µn s√†ng c√†i ƒë·∫∑t.");
                logMessage("[OK] K·∫øt n·ªëi ADB th√†nh c√¥ng!", "success");
            } else {
                setStatus("[L·ªñI] Kh√¥ng th·ªÉ k·∫øt n·ªëi. Ki·ªÉm tra l·∫°i IP ho·∫∑c WiFi.");
                logMessage("[L·ªñI] K·∫øt n·ªëi th·∫•t b·∫°i!", "error");
            }
        }

        function restorePackages() {
            logMessage("ƒêang kh√¥i ph·ª•c tr·∫°ng th√°i c≈© c·ªßa loa...", "warn");
            var packages = [
                "com.phicomm.speaker.player",
                "com.phicomm.speaker.device",
                "com.phicomm.speaker.airskill",
                "com.phicomm.speaker.exceptionreporter",
                "com.phicomm.speaker.ijetty",
                "com.phicomm.speaker.netctl",
                "com.phicomm.speaker.otaservice",
                "com.phicomm.speaker.systemtool",
                "com.phicomm.speaker.productiontest",
                "com.phicomm.speaker.bugreport"
            ];
            for (var i = 0; i < packages.length; i++) {
                runAdbCommand("shell /system/bin/pm unhide " + packages[i]);
            }
            logMessage("[OK] ƒê√£ kh√¥i ph·ª•c tr·∫°ng th√°i c≈©.", "success");
        }

        function startInstall() {
            if (isInstalling) return;
            if (!installMode) {
                alert("Vui l√≤ng ch·ªçn ch·∫ø ƒë·ªô: C√†i ƒë·∫∑t m·ªõi ho·∫∑c C·∫≠p nh·∫≠t!");
                return;
            }
            
            deviceIP = document.getElementById("ipAddress").value;
            if (!deviceIP) {
                alert("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ IP!");
                return;
            }
            
            isInstalling = true;
            var installBtn = document.getElementById("installBtn");
            
            installBtn.disabled = true;
            installBtn.innerHTML = "ƒêANG C√ÄI ƒê·∫∂T...";
            installBtn.style.background = "#45475a";
            
            document.getElementById("logBox").innerHTML = "";
            
            var totalSteps = installMode === "new" ? 6 : 5;
            for (var s = 1; s <= totalSteps; s++) setStep(s, "");
            
            var MAX_INSTALL_RETRY = 8;
            
            try {
                var currentStep = 1;
                var result;
                
                // Step 1: Connect
                setStep(currentStep, "active");
                setProgress(5);
                setStatus("B∆∞·ªõc " + currentStep + ": ƒêang k·∫øt n·ªëi thi·∫øt b·ªã...");
                
                logMessage("ƒêang d·ªçn d·∫πp k·∫øt n·ªëi c≈©...", "info");
                
                // Kill all ADB processes thoroughly
                runAdbCommand("kill-server");
                sleep(500);
                shell.Run('cmd /c taskkill /f /t /im adb.exe', 0, true);
                sleep(1000);
                
                // Start fresh ADB server
                logMessage("ƒêang kh·ªüi ƒë·ªông ADB server m·ªõi...", "info");
                runAdbCommand("start-server");
                sleep(1000);
                
                // Retry connection multiple times
                var connectRetry = 0;
                var connectSuccess = false;
                var MAX_CONNECT_RETRY = 5;
                
                while (connectRetry < MAX_CONNECT_RETRY && !connectSuccess) {
                    connectRetry++;
                    logMessage("ƒêang k·∫øt n·ªëi ƒë·∫øn " + deviceIP + ":5555... (l·∫ßn " + connectRetry + "/" + MAX_CONNECT_RETRY + ")", "info");
                    
                    result = runAdbCommand("connect " + deviceIP + ":5555");
                    logMessage(result, "info");
                    
                    sleep(1500);
                    
                    var devices = runAdbCommand("devices");
                    if (devices.indexOf(deviceIP) >= 0 && devices.indexOf("device") >= 0) {
                        connectSuccess = true;
                        break;
                    }
                    
                    if (connectRetry < MAX_CONNECT_RETRY) {
                        logMessage("[C·∫¢NH B√ÅO] K·∫øt n·ªëi th·∫•t b·∫°i, th·ª≠ l·∫°i...", "warn");
                        sleep(1000);
                    }
                }
                
                if (!connectSuccess) {
                    throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi sau " + MAX_CONNECT_RETRY + " l·∫ßn th·ª≠! Ki·ªÉm tra IP ho·∫∑c WiFi.");
                }
                
                setStep(currentStep, "done");
                logMessage("[OK] K·∫øt n·ªëi th√†nh c√¥ng!", "success");
                setProgress(10);
                currentStep++;
                
                // Step 2: Hide old packages (NEW INSTALL ONLY)
                if (installMode === "new") {
                    setStep(currentStep, "active");
                    setStatus("B∆∞·ªõc " + currentStep + ": ƒêang t·∫Øt ·ª©ng d·ª•ng c≈©...");
                    
                    var packages = [
                        "com.phicomm.speaker.player",
                        "com.phicomm.speaker.airskill",
                        "com.phicomm.speaker.exceptionreporter",
                        "com.phicomm.speaker.ijetty",
                        "com.phicomm.speaker.netctl",
                        "com.phicomm.speaker.systemtool",
                        "com.phicomm.speaker.device",
                        "com.phicomm.speaker.productiontest",
                        "com.phicomm.speaker.bugreport"
                    ];
                    
                    for (var i = 0; i < packages.length; i++) {
                        logMessage("T·∫Øt " + packages[i].split(".").pop() + "...", "info");
                        var hideResult = runAdbCommand("shell /system/bin/pm hide " + packages[i]);
                        if (!checkConnection(hideResult)) {
                            reconnectAdb();
                            i--;
                            continue;
                        }
                        setProgress(10 + Math.floor((i / packages.length) * 15));
                        sleep(100);
                    }
                    
                    setStep(currentStep, "done");
                    logMessage("[OK] ƒê√£ t·∫Øt c√°c ·ª©ng d·ª•ng c≈©!", "success");
                    setProgress(25);
                    currentStep++;
                }
                
                // Step: Push APK
                setStep(currentStep, "active");
                setStatus("B∆∞·ªõc " + currentStep + ": ƒêang sao ch√©p APK...");
                
                logMessage("ƒêang sao ch√©p APK l√™n thi·∫øt b·ªã...", "info");
                result = runAdbCommand('push "' + apkPath + '" /data/local/tmp/app-voicebot.apk');
                
                if (!checkConnection(result)) {
                    reconnectAdb();
                    result = runAdbCommand('push "' + apkPath + '" /data/local/tmp/app-voicebot.apk');
                }
                
                logMessage(result, "info");
                setStep(currentStep, "done");
                logMessage("[OK] Sao ch√©p APK th√†nh c√¥ng!", "success");
                setProgress(installMode === "new" ? 40 : 30);
                currentStep++;
                
                // Step 3: Install APK
                setStep(currentStep, "active");
                setStatus("B∆∞·ªõc " + currentStep + ": ƒêang c√†i ƒë·∫∑t VoiceBot...");
                
                var installRetry = 0;
                var installSuccess = false;
                
                while (installRetry < MAX_INSTALL_RETRY && !installSuccess) {
                    installRetry++;
                    logMessage("ƒêang c√†i ƒë·∫∑t... (l·∫ßn " + installRetry + "/" + MAX_INSTALL_RETRY + ")", "info");
                    
                    result = runAdbCommand("shell /system/bin/pm install -r /data/local/tmp/app-voicebot.apk");
                    
                    if (!checkConnection(result)) {
                        reconnectAdb();
                        installRetry = 0;
                        continue;
                    }
                    
                    if (result.indexOf("Success") >= 0) {
                        installSuccess = true;
                        break;
                    }
                    
                    if (result.indexOf("INSTALL_FAILED_DEXOPT") >= 0) {
                        logMessage("[C·∫¢NH B√ÅO] INSTALL_FAILED_DEXOPT - Th·ª≠ l·∫°i sau 1 gi√¢y...", "warn");
                        sleep(1000);
                        continue;
                    }
                    
                    if (result.indexOf("INSTALL_FAILED_UPDATE_INCOMPATIBLE") >= 0) {
                        logMessage("[C·∫¢NH B√ÅO] Ph√°t hi·ªán phi√™n b·∫£n c≈© kh√¥ng t∆∞∆°ng th√≠ch!", "warn");
                        logMessage("ƒêang g·ª° c√†i ƒë·∫∑t phi√™n b·∫£n c≈©...", "info");
                        runAdbCommand("shell /system/bin/pm uninstall info.dourok.voicebot");
                        logMessage("[OK] ƒê√£ g·ª° c√†i ƒë·∫∑t phi√™n b·∫£n c≈©.", "success");
                        sleep(1000);
                        installRetry = 0;
                        continue;
                    }
                    
                    logMessage(result, "error");
                    sleep(1000);
                }
                
                if (!installSuccess) {
                    logMessage("[L·ªñI] C√†i ƒë·∫∑t th·∫•t b·∫°i sau " + MAX_INSTALL_RETRY + " l·∫ßn th·ª≠!", "error");
                    if (installMode === "new") restorePackages();
                    throw new Error("C√†i ƒë·∫∑t APK th·∫•t b·∫°i!");
                }
                
                setStep(currentStep, "done");
                logMessage("[OK] C√†i ƒë·∫∑t VoiceBot th√†nh c√¥ng!", "success");
                setProgress(installMode === "new" ? 70 : 60);
                currentStep++;
                
                // Step 4: Grant permissions
                setStep(currentStep, "active");
                setStatus("B∆∞·ªõc " + currentStep + ": ƒêang c·∫•p quy·ªÅn...");
                
                var permissions = [
                    "android.permission.RECORD_AUDIO",
                    "android.permission.INTERNET",
                    "android.permission.ACCESS_NETWORK_STATE",
                    "android.permission.ACCESS_WIFI_STATE",
                    "android.permission.CHANGE_WIFI_STATE",
                    "android.permission.BLUETOOTH",
                    "android.permission.BLUETOOTH_ADMIN",
                    "android.permission.WRITE_EXTERNAL_STORAGE",
                    "android.permission.READ_EXTERNAL_STORAGE"
                ];
                
                logMessage("ƒêang c·∫•p quy·ªÅn cho ·ª©ng d·ª•ng...", "info");
                for (var j = 0; j < permissions.length; j++) {
                    runAdbCommand("shell pm grant info.dourok.voicebot " + permissions[j]);
                    setProgress((installMode === "new" ? 70 : 60) + Math.floor((j / permissions.length) * 15));
                }
                
                setStep(currentStep, "done");
                logMessage("[OK] ƒê√£ c·∫•p quy·ªÅn th√†nh c√¥ng!", "success");
                setProgress(installMode === "new" ? 85 : 80);
                currentStep++;
                
                // Step 5: Start app
                setStep(currentStep, "active");
                setStatus("B∆∞·ªõc " + currentStep + ": ƒêang kh·ªüi ƒë·ªông ·ª©ng d·ª•ng...");
                
                logMessage("ƒêang kh·ªüi ƒë·ªông VoiceBot...", "info");
                runAdbCommand("shell am start -n info.dourok.voicebot/.java.activities.MainActivity");
                sleep(1000);
                
                logMessage("ƒêang d·ªçn d·∫πp file t·∫°m...", "info");
                runAdbCommand("shell rm /data/local/tmp/app-voicebot.apk");
                
                setStep(currentStep, "done");
                setProgress(100);
                
                logMessage("", "info");
                logMessage("=========================================", "success");
                logMessage("[OK] C√ÄI ƒê·∫∂T TH√ÄNH C√îNG!", "success");
                logMessage("=========================================", "success");
                
                setStatus("[OK] C√ÄI ƒê·∫∂T HO√ÄN T·∫§T!");
                
                if (installMode === "new") {
                    alert("C√ÄI ƒê·∫∂T TH√ÄNH C√îNG!\n\n" +
                          "B∆∞·ªõc ti·∫øp theo:\n" +
                          "1. R√öT ƒêI·ªÜN c·ªßa loa\n" +
                          "2. Ch·ªù 10-15 gi√¢y\n" +
                          "3. C·∫ÆM L·∫†I ƒêI·ªÜN cho loa\n" +
                          "4. ƒê·ª£i loa kh·ªüi ƒë·ªông (kho·∫£ng 30 gi√¢y)\n" +
                          "5. GI·ªÆ N√öT ƒë·∫øn khi nghe 'V√†o ch·∫ø ƒë·ªô c√†i ƒë·∫∑t WiFi'\n" +
                          "6. K·∫øt n·ªëi m√°y t√≠nh v√†o WiFi: Phicomm_R1\n" +
                          "7. M·ªü tr√¨nh duy·ªát: http://192.168.43.1:8080\n" +
                          "8. Ch·ªçn WiFi nh√† b·∫°n v√† nh·∫≠p m·∫≠t kh·∫©u\n\n" +
                          "Sau khi k·∫øt n·ªëi WiFi, loa s·∫Ω ƒë·ªçc ƒë·ªãa ch·ªâ IP.");
                } else {
                    alert("C·∫¨P NH·∫¨T TH√ÄNH C√îNG!\n\n" +
                          "Loa ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t phi√™n b·∫£n " + localVersion + ".\n" +
                          "VoiceBot ƒë√£ t·ª± ƒë·ªông kh·ªüi ƒë·ªông.\n\n" +
                          "B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng ngay!");
                }
                
            } catch(e) {
                logMessage("[L·ªñI] " + e.message, "error");
                setStatus("[L·ªñI] " + e.message);
                
                var totalSteps2 = installMode === "new" ? 6 : 5;
                for (var k = 1; k <= totalSteps2; k++) {
                    var prefix2 = installMode === "new" ? "stepN" : "stepU";
                    var stepEl = document.getElementById(prefix2 + k);
                    if (stepEl && stepEl.className.indexOf("active") >= 0) {
                        setStep(k, "error");
                        break;
                    }
                }
                
                alert("C√ÄI ƒê·∫∂T TH·∫§T B·∫†I!\n\n" + e.message + "\n\nVui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.");
            }
            
            isInstalling = false;
            installBtn.disabled = false;
            installBtn.innerHTML = installMode === "new" ? "B·∫ÆT ƒê·∫¶U C√ÄI ƒê·∫∂T M·ªöI" : "B·∫ÆT ƒê·∫¶U C·∫¨P NH·∫¨T";
            installBtn.style.background = "#a6e3a1";
        }

        window.onload = init;
        window.resizeTo(880, 1100);
    </script>
</body>
</html>